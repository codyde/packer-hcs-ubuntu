# Packer build for HashiCorp Consul Service on Azure VMs (Ubuntu) 

This Packer manifest builds an image that is preconfigured with all the items to automatically join your HCS cluster
at the time of boot. This allows you to quickly get started deploying applications on the server. This image comes 
prepackaged with the Envoy binary that you can use to deploy services in the service mesh design pattern. 

This OS is Ubuntu 18.04 and performs the following configuration via the Ansible provisioner in Packer. These configurations 
are in the `playbook.yml` file in this directory: 

* Creates necessary directory structure for Consul components
* Creates a service for Consul to run under
* Copies the necessary Consul configurations (agent configuration, certificate)
* Downloads the most recent Envoy binary 
* Creates a stopped Envoy service for the Envoy sidecar (set to not start so you can finish configurations on the application side)

## Configuration

In order to use this build, you must complete the following steps

* Update the `packer.json` with the details from your HCS environment (these can mostly be retrieved using the Azure CLI)
* Run the `retrieve-hcs-details.sh` script from this directory to pull down your HCS details and build your `consul.config.json` file
* Update the `ansiblevars.yml` file with the `servicename` variable (the service you plan on registering first, if applicable) and the `defaultacl` ACL token (the SecretID field in the acl.json file that is generated by the script) Note: you should create new, node/service specific ACL token for
security reasons. Using the bootstrap token is NOT preferred. 
* Run `packer build packer.json` to deploy the image! 